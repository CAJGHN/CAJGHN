<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAJGHN Arcade</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  margin: 0;
  overflow: hidden;
  background: #000;
  font-family: sans-serif;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  gap: 20px;
  flex-wrap: wrap;
}
#game-container {
  position: relative;
  width: 400px;
  max-width: 95vw;
  height: 600px;
  background: #111;
  border: 3px solid #00ff7f;
  overflow: hidden;
}
#player {
  position: absolute;
  bottom: 20px;
  left: 180px;
  width: 40px;
  height: 40px;
  background: #00ff7f;
  border-radius: 50%;
}
#scoreboard {
  position: absolute;
  top: 10px;
  left: 10px;
  color: #00ff7f;
  font-size: 1.6rem;
  text-shadow: 0 0 8px #00ff7f, 0 0 16px #00ff7f;
}
#playerName {
  position: absolute;
  top: 10px;
  right: 10px;
  color: #00ff7f;
  font-size: 1.2rem;
}
#overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: #00ff7f;
  font-size: 2.5rem;
  z-index: 10;
  font-weight: bold;
  text-align: center;
}
.touch-btn {
  position: absolute;
  bottom: 30px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(0,255,127,0.2);
  border: 2px solid #00ff7f;
  color: #00ff7f;
  font-size: 2.2rem;
  text-align: center;
  line-height: 56px;
  font-weight: bold;
  user-select: none;
}
#left-btn { left: 20px; transform: rotate(-90deg); }
#right-btn { right: 20px; transform: rotate(90deg); }
#leaderboard-container {
  background: #111;
  border: 3px solid #00ff7f;
  color: #00ff7f;
  padding: 14px;
  width: 280px;
  max-height: 600px;
  font-size: 1.3rem;
  line-height: 1.6rem;
  overflow-y: auto;
  text-align: left;
}
#leaderboard-title {
  font-weight: bold;
  text-align: center;
  margin-bottom: 10px;
  font-size: 1.6rem;
}
#refresh-btn {
  margin-top: 12px;
  padding: 8px 14px;
  background: #00ff7f;
  color: #000;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.1rem;
  transition: background .15s, transform .06s;
}
#refresh-btn:active { transform: scale(.98); }
#start-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}
#name-input {
  padding: 6px;
  border-radius: 4px;
  border: 1px solid #00ff7f;
  background: #111;
  color: #00ff7f;
  width: 150px;
  text-align: center;
  font-size: 1rem;
}
#start-btn {
  background: #00ff7f;
  color: #000;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}
</style>
</head>
<body>
  <div id="game-container">
    <div id="scoreboard">
      <div id="score">Score: 0</div>
    </div>
    <div id="playerName"></div>

    <div id="player"></div>
    <div id="overlay"></div>

    <div id="left-btn" class="touch-btn">▲</div>
    <div id="right-btn" class="touch-btn">▲</div>
  </div>

  <div id="leaderboard-container">
    <div id="leaderboard-title">Leaderboard</div>
    <div id="leaderboardList">Loading...</div>
    <button id="refresh-btn">Refresh</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, query, orderByChild, limitToLast, get }
  from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAS5OwF0mHyIbq0AKNrY3c8K3yTrUubdDc",
  authDomain: "game-715ed.firebaseapp.com",
  projectId: "game-715ed",
  storageBucket: "game-715ed.firebasestorage.app",
  messagingSenderId: "1074016214448",
  appId: "1:1074016214448:web:d82612cbf2764fcf168a75",
  databaseURL: "https://game-715ed-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const player = document.getElementById('player');
const gameContainer = document.getElementById('game-container');
const scoreEl = document.getElementById('score');
const overlay = document.getElementById('overlay');
const leftBtn = document.getElementById('left-btn');
const rightBtn = document.getElementById('right-btn');
const nameEl = document.getElementById('playerName');
const leaderboardList = document.getElementById('leaderboardList');
const refreshBtn = document.getElementById('refresh-btn');

let playerName = '';
let playerX = 180;
let obstacles = [];
let score = 0;
let speed = 2;
let gameRunning = false;
let gameLoopId;
let leftPressed = false;
let rightPressed = false;
let turn = 0;
let obstaclesPerTurn = 1;
let turnInterval;

function showNameInput() {
  overlay.innerHTML = `
    <form id="start-form">
      <input id="name-input" type="text" placeholder="Enter nickname" required />
      <button id="start-btn" type="submit">Start Game</button>
    </form>`;
  overlay.style.display = 'flex';

  const form = document.getElementById('start-form');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const input = document.getElementById('name-input');
    playerName = input.value.trim() || "Player";
    nameEl.textContent = playerName;
    countdownStart();
  });
}

function spawnObstacle() {
  const obs = document.createElement('div');
  obs.classList.add('obstacle');
  obs.style.left = Math.random() * (gameContainer.clientWidth - 40) + 'px';
  obs.style.top = '-50px';
  obs.style.position = 'absolute';
  obs.style.width = '40px';
  obs.style.height = '40px';
  obs.style.background = 'red';
  gameContainer.appendChild(obs);
  obstacles.push(obs);
}

function runTurn() {
  turn++;
  for (let i = 0; i < obstaclesPerTurn; i++) {
    const delay = Math.random() * 1500;
    setTimeout(spawnObstacle, delay);
  }
  if (turn % 3 === 0) obstaclesPerTurn++;
  if (turn % 6 === 0) speed += 0.5;
}

function moveObstacles() {
  obstacles.forEach((obs, idx) => {
    let top = parseFloat(obs.style.top) + speed;
    obs.style.top = top + 'px';
    if (top > gameContainer.clientHeight) {
      obs.remove();
      obstacles.splice(idx, 1);
      score++;
      scoreEl.textContent = "Score: " + score;
    }
    const pRect = player.getBoundingClientRect();
    const oRect = obs.getBoundingClientRect();
    if (!(pRect.right < oRect.left || pRect.left > oRect.right || pRect.bottom < oRect.top || pRect.top > oRect.bottom)) {
      endGame();
    }
  });
}

function gameLoop() {
  if (!gameRunning) return;
  if (leftPressed)  playerX -= 5;
  if (rightPressed) playerX += 5;
  playerX = Math.max(0, Math.min(playerX, gameContainer.clientWidth - 40));
  player.style.left = playerX + 'px';
  moveObstacles();
  gameLoopId = requestAnimationFrame(gameLoop);
}

document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft')  leftPressed = true;
  if (e.key === 'ArrowRight') rightPressed = true;
});
document.addEventListener('keyup', e => {
  if (e.key === 'ArrowLeft')  leftPressed = false;
  if (e.key === 'ArrowRight') rightPressed = false;
});

leftBtn.onmousedown = () => leftPressed = true;
leftBtn.onmouseup = () => leftPressed = false;
leftBtn.ontouchstart = e => { e.preventDefault(); leftPressed = true; };
leftBtn.ontouchend = () => leftPressed = false;

rightBtn.onmousedown = () => rightPressed = true;
rightBtn.onmouseup = () => rightPressed = false;
rightBtn.ontouchstart = e => { e.preventDefault(); rightPressed = true; };
rightBtn.ontouchend = () => rightPressed = false;

function startGame() {
  overlay.style.display = 'none';
  obstacles.forEach(o => o.remove());
  obstacles = [];
  playerX = 180;
  score = 0;
  speed = 2;
  turn = 0;
  obstaclesPerTurn = 1;
  scoreEl.textContent = "Score: 0";
  gameRunning = true;
  turnInterval = setInterval(runTurn, 2000);
  gameLoop();
}

function countdownStart() {
  let count = 3;
  overlay.style.display = 'flex';
  overlay.textContent = count;
  const interval = setInterval(() => {
    count--;
    if (count > 0) {
      overlay.textContent = count;
    } else {
      clearInterval(interval);
      startGame();
    }
  }, 1000);
}

async function updateLeaderboard() {
  refreshBtn.disabled = true;
  const oldText = refreshBtn.textContent;
  refreshBtn.textContent = 'Loading...';
  leaderboardList.innerHTML = 'Loading...';
  try {
    const topScoresQuery = query(ref(db, 'scores'), orderByChild('score'), limitToLast(20));
    const snap = await get(topScoresQuery);
    let arr = [];
    snap.forEach(child => {
      const v = child.val();
      if (v) {
        if (typeof v.score === 'string' && !isNaN(Number(v.score))) v.score = Number(v.score);
        arr.push(v);
      }
    });
    if (arr.length === 0) {
      const allSnap = await get(ref(db, 'scores'));
      let arr2 = [];
      allSnap.forEach(c => {
        const v = c.val();
        if (v) {
          if (typeof v.score === 'string' && !isNaN(Number(v.score))) v.score = Number(v.score);
          arr2.push(v);
        }
      });
      arr = arr2;
    }
    arr.sort((a,b) => (b.score||0) - (a.score||0));
    arr = arr.slice(0,20);
    if (arr.length === 0) {
      leaderboardList.innerHTML = 'No records';
    } else {
      leaderboardList.innerHTML = arr.map((e,i) => `${i+1}. ${e.name} - ${e.score}`).join('<br>');
    }
  } catch (err) {
    console.error('Primary leaderboard update failed:', err);
    try {
      const allSnap = await get(ref(db, 'scores'));
      let arr = [];
      allSnap.forEach(c => {
        const v = c.val();
        if (v) {
          if (typeof v.score === 'string' && !isNaN(Number(v.score))) v.score = Number(v.score);
          arr.push(v);
        }
      });
      arr.sort((a,b) => (b.score||0) - (a.score||0));
      arr = arr.slice(0,20);
      leaderboardList.innerHTML = arr.length ? arr.map((e,i) => `${i+1}. ${e.name} - ${e.score}`).join('<br>') : 'No records';
    } catch (err2) {
      console.error('Fallback leaderboard update also failed:', err2);
      leaderboardList.innerHTML = 'Update failed';
    }
  } finally {
    refreshBtn.disabled = false;
    refreshBtn.textContent = oldText;
  }
}

function saveScore() {
  push(ref(db, 'scores'), { name: playerName, score: score });
  updateLeaderboard();
}

function endGame() {
  gameRunning = false;
  clearInterval(turnInterval);
  cancelAnimationFrame(gameLoopId);
  saveScore();
  overlay.textContent = `Game Over\nScore: ${score}\nPress F5 to restart`;
  overlay.style.display = 'flex';
}

refreshBtn.addEventListener('click', updateLeaderboard);

window.addEventListener('load', () => {
  showNameInput();
  updateLeaderboard();
});
</script>
</body>
</html>
