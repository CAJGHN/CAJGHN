<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>CAJGHN Talk</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
html, body { margin:0; padding:0; font-family:sans-serif; background:#111; color:#fff; height:100%; }
#nickname-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:20; }
#nickname-form { display:flex; flex-direction:column; gap:12px; background:#222; padding:20px; border-radius:12px; text-align:center; width:90%; max-width:300px; }
#nickname-form input { padding:8px; border-radius:6px; border:none; outline:none; background:#333; color:#fff; width:100%; }
#nickname-form button { padding:8px 16px; border:none; border-radius:6px; background:#00ff7f; color:#000; cursor:pointer; }
#header { text-align:center; font-size:0.9rem; color:#aaa; padding:6px 0; flex-shrink:0; }
#chat-container { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; word-wrap:break-word; }
.message { display:flex; flex-direction:column; max-width:80%; padding:8px 12px; border-radius:12px; word-break:break-word; white-space:pre-wrap; }
.message.left { align-self:flex-start; background:#222; color:#fff; }
.message.right { align-self:flex-end; background:#00ff7f; color:#000; }
.meta { font-size:0.75rem; color:#aaa; margin-top:4px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:4px; }
#input-container { display:flex; padding:10px; background:#222; flex-shrink:0; }
#message-input { flex:1; padding:8px; border-radius:6px; border:none; outline:none; margin-right:10px; background:#333; color:#fff; resize:none; }
#send-btn { padding:8px 16px; background:#00ff7f; color:#000; border:none; border-radius:6px; cursor:pointer; }
@media (max-width:500px){
  #message-input { font-size:0.9rem; }
  #send-btn { font-size:0.9rem; padding:6px 12px; }
}
</style>
</head>
<body class="flex flex-col h-screen">

<div id="nickname-overlay">
  <form id="nickname-form">
    <h2 class="text-lg font-bold">Enter your nickname</h2>
    <input type="text" id="nickname-input" placeholder="Nickname" required />
    <button type="submit">Start Chat</button>
  </form>
</div>

<div id="header"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
  <button id="send-btn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxGlseUWqf4uevaxiu407dZsx_YU6MPuo",
  authDomain: "tktk-a9131.firebaseapp.com",
  projectId: "tktk-a9131",
  storageBucket: "tktk-a9131.appspot.com",
  messagingSenderId: "541341583059",
  appId: "1:541341583059:web:be1791d22c6d33fdaeb626",
  databaseURL: "https://tktk-a9131-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userName = localStorage.getItem("cajghn_nickname") || "";

const nicknameOverlay = document.getElementById("nickname-overlay");
const nicknameForm = document.getElementById("nickname-form");
const nicknameInput = document.getElementById("nickname-input");
const chatContainer = document.getElementById("chat-container");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const header = document.getElementById("header");

function updateHeaderTime(){
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2,'0');
  const seconds = now.getSeconds().toString().padStart(2,'0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const hour12 = (hours % 12) || 12;
  const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
  header.textContent = `${ampm} ${hour12}:${minutes}:${seconds} ${dateStr}`;
}
setInterval(updateHeaderTime, 1000);

function formatTime(timestamp){
  const date = new Date(timestamp);
  const hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2,'0');
  const seconds = date.getSeconds().toString().padStart(2,'0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  const hour12 = (hours % 12) || 12;
  return `${ampm} ${hour12}:${minutes}:${seconds}`;
}

function addMessage(name, text, timestamp){
  const div = document.createElement("div");
  div.classList.add("message");
  div.classList.add(name === userName ? "right" : "left");
  div.innerHTML = `<div>${text}</div><div class="meta"><span>${name}</span><span>${formatTime(timestamp)}</span></div>`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function loadMessages(){
  const snapshot = await get(ref(db, "messages"));
  chatContainer.innerHTML = "";
  snapshot.forEach(child => {
    const msg = child.val();
    const time = msg.timestamp ? msg.timestamp : Date.now();
    addMessage(msg.name, msg.text, time);
  });
}

sendBtn.addEventListener("click", async () => {
  const text = messageInput.value.trim();
  if(!text) return;
  await push(ref(db, "messages"), { name: userName, text: text, timestamp: serverTimestamp() });
  messageInput.value = "";
  chatContainer.scrollTop = chatContainer.scrollHeight;
});

messageInput.addEventListener("keyup", (e) => {
  if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
  else { messageInput.style.height = "auto"; messageInput.style.height = (messageInput.scrollHeight)+"px"; }
});

nicknameForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const nick = nicknameInput.value.trim();
  if(!nick) return;
  userName = nick;
  localStorage.setItem("cajghn_nickname", nick);
  nicknameOverlay.style.display = "none";
  loadMessages();
});

if(userName){
  nicknameOverlay.style.display = "none";
  loadMessages();
}

setInterval(loadMessages, 1000);
window.addEventListener('resize', () => { chatContainer.scrollTop = chatContainer.scrollHeight; });
messageInput.addEventListener('focus', () => { setTimeout(()=>{ chatContainer.scrollTop = chatContainer.scrollHeight; },300); });
</script>

</body>
</html>
