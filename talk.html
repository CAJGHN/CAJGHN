<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAJGHN Talk</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#fff; display:flex; flex-direction:column; height:100vh; }
#nickname-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:20; }
#nickname-form { display:flex; flex-direction:column; gap:12px; background:#222; padding:20px; border-radius:12px; text-align:center; }
#nickname-form input { padding:8px; border-radius:6px; border:none; outline:none; background:#333; color:#fff; }
#nickname-form button { padding:8px 16px; border:none; border-radius:6px; background:#00ff7f; color:#000; cursor:pointer; }
#chat-container { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
.message { display:flex; flex-direction:column; max-width:80%; padding:8px 12px; border-radius:12px; word-break:break-word; }
.message.left { align-self:flex-start; background:#222; color:#fff; }
.message.right { align-self:flex-end; background:#00ff7f; color:#000; }
.meta { font-size:0.75rem; color:#aaa; margin-top:4px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:4px; }
#input-container { display:flex; padding:10px; background:#222; }
#message-input { flex:1; padding:8px; border-radius:6px; border:none; outline:none; margin-right:10px; background:#333; color:#fff; }
#send-btn { padding:8px 16px; background:#00ff7f; color:#000; border:none; border-radius:6px; cursor:pointer; }
@media (max-width: 500px){
  #message-input { font-size:0.9rem; }
  #send-btn { font-size:0.9rem; padding:6px 12px; }
}
</style>
</head>
<body>

<div id="nickname-overlay">
  <form id="nickname-form">
    <h2 class="text-lg font-bold">Enter your nickname</h2>
    <input type="text" id="nickname-input" placeholder="Nickname" required />
    <button type="submit">Start Chat</button>
  </form>
</div>

<div id="chat-container"></div>
<div id="input-container">
  <input type="text" id="message-input" placeholder="Type a message..." />
  <button id="send-btn">Send</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxGlseUWqf4uevaxiu407dZsx_YU6MPuo",
  authDomain: "tktk-a9131.firebaseapp.com",
  projectId: "tktk-a9131",
  storageBucket: "tktk-a9131.appspot.com",
  messagingSenderId: "541341583059",
  appId: "1:541341583059:web:be1791d22c6d33fdaeb626",
  databaseURL: "https://tktk-a9131-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userName = localStorage.getItem("cajghn_nickname") || "";

const nicknameOverlay = document.getElementById("nickname-overlay");
const nicknameForm = document.getElementById("nickname-form");
const nicknameInput = document.getElementById("nickname-input");
const chatContainer = document.getElementById("chat-container");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");

function formatTime(timestamp){
  const date = new Date(timestamp);
  return date.getHours().toString().padStart(2,'0')+':'+
         date.getMinutes().toString().padStart(2,'0');
}

function addMessage(name, text, timestamp){
  const div = document.createElement("div");
  div.classList.add("message");
  div.classList.add(name === userName ? "right" : "left");
  div.innerHTML = `
    <div>${text}</div>
    <div class="meta"><span>${name}</span><span>${formatTime(timestamp)}</span></div>
  `;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function loadMessages(){
  const snapshot = await get(ref(db, "messages"));
  chatContainer.innerHTML = "";
  snapshot.forEach(child => {
    const msg = child.val();
    const time = msg.timestamp ? msg.timestamp : Date.now();
    addMessage(msg.name, msg.text, time);
  });
}

sendBtn.addEventListener("click", async () => {
  const text = messageInput.value.trim();
  if(!text) return;
  await push(ref(db, "messages"), {
    name: userName,
    text: text,
    timestamp: serverTimestamp()
  });
  messageInput.value = "";
});

messageInput.addEventListener("keyup", (e) => {
  if(e.key === "Enter") sendBtn.click();
});

nicknameForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const nick = nicknameInput.value.trim();
  if(!nick) return;
  userName = nick;
  localStorage.setItem("cajghn_nickname", nick);
  nicknameOverlay.style.display = "none";
  loadMessages();
});

if(userName){
  nicknameOverlay.style.display = "none";
  loadMessages();
}

setInterval(loadMessages, 1000);
</script>

</body>
</html>
