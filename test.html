<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAJGHN_lego_head.stl Viewer</title>
  <style>
    html, body { height: 100%; margin: 0; background: #0b0b0d; color: #eee; font-family: Arial, sans-serif; }
    #viewer { width: 100%; height: 100vh; display: block; }
    .ui {
      position: absolute; top: 12px; left: 12px; z-index: 10;
      background: rgba(0,0,0,0.45); padding: 10px; border-radius: 8px;
      color: #fff; font-size: 13px;
    }
    .ui label { display:inline-block; margin-right:8px; }
    .ui input[type="range"] { vertical-align: middle; }
    .credits { position: absolute; right: 12px; bottom: 12px; color: #aaa; font-size:12px; }
  </style>
</head>
<body>
  <div class="ui">
    <div><strong>STL 뷰어</strong></div>
    <div style="margin-top:6px;">
      <label>Scale</label>
      <input id="scale" type="range" min="0.1" max="3" value="1" step="0.01">
      <span id="scaleVal">1.00</span>
    </div>
    <div style="margin-top:6px;">
      <label>Color</label>
      <input id="color" type="color" value="#b2b2b2">
    </div>
    <div style="margin-top:6px;">
      <button id="reset">Reset camera</button>
    </div>
  </div>

  <div id="viewer"></div>
  <div class="credits">Use mouse: drag to rotate · wheel to zoom · right-drag to pan</div>

  <!-- three.js modules (module imports) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { STLLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/STLLoader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';

    // --- 기본 세팅 ---
    const container = document.getElementById('viewer');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0b0d);

    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 40, 80);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    // 조명
    const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
    hemi.position.set(0, 50, 0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(0, 50, 50);
    dir.castShadow = true;
    scene.add(dir);

    // 바닥 레퍼런스
    const grid = new THREE.GridHelper(200, 40, 0x222222, 0x151515);
    grid.material.opacity = 0.4;
    grid.material.transparent = true;
    scene.add(grid);

    // 컨트롤
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;

    // 모델 컨테이너 (scale/center 조절을 위해)
    const modelGroup = new THREE.Group();
    scene.add(modelGroup);

    // STL 로드
    const loader = new STLLoader();
    const stlPath = 'CAJGHN_lego_head.stl'; // <-- 같은 폴더에 이 파일을 둡니다.

    // 기본 머티리얼 (색상 변경 가능)
    const material = new THREE.MeshStandardMaterial({ color: 0xb2b2b2, metalness: 0.1, roughness: 0.6 });

    loader.load(stlPath,
      (geometry) => {
        // 중심 맞추기
        geometry.computeBoundingBox();
        const bbox = geometry.boundingBox;
        const size = new THREE.Vector3();
        bbox.getSize(size);

        const center = new THREE.Vector3();
        bbox.getCenter(center);

        const mesh = new THREE.Mesh(geometry, material);
        // STL은 보통 중앙이 좌표의 +/-. center로 맞춰 이동
        mesh.geometry.translate(-center.x, -center.y, -center.z);

        // 모델을 적절한 크기로 맞춤 (너비 기준)
        const maxDim = Math.max(size.x, size.y, size.z);
        const initialScale = 1.0;
        mesh.scale.setScalar(initialScale);

        mesh.castShadow = true;
        mesh.receiveShadow = true;

        modelGroup.add(mesh);

        // 카메라를 모델에 맞춰 재설정
        const fitOffset = 1.5;
        const distance = Math.max(size.x, size.y, size.z) * fitOffset;
        camera.position.set(distance, distance, distance);
        camera.lookAt(0, 0, 0);
        controls.update();
      },
      (xhr) => {
        // progress (선택)
        // console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
      },
      (error) => {
        console.error('STL load error:', error);
        const msg = document.createElement('div');
        msg.style.position = 'absolute';
        msg.style.left = '50%';
        msg.style.top = '50%';
        msg.style.transform = 'translate(-50%,-50%)';
        msg.style.background = 'rgba(0,0,0,0.6)';
        msg.style.color = '#fff';
        msg.style.padding = '12px';
        msg.style.borderRadius = '8px';
        msg.innerText = 'STL 파일 로드 실패 — 브라우저 콘솔을 확인하세요.';
        document.body.appendChild(msg);
      }
    );

    // 반응형
    window.addEventListener('resize', onWindowResize);
    function onWindowResize() {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    }

    // 애니메이션 루프
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // --- UI 바인딩 (scale, color, reset) ---
    const scaleInput = document.getElementById('scale');
    const scaleVal = document.getElementById('scaleVal');
    const colorInput = document.getElementById('color');
    const resetBtn = document.getElementById('reset');

    scaleInput.addEventListener('input', () => {
      const s = parseFloat(scaleInput.value);
      scaleVal.innerText = s.toFixed(2);
      modelGroup.scale.setScalar(s);
    });

    colorInput.addEventListener('input', () => {
      const hex = colorInput.value;
      material.color.set(hex);
    });

    resetBtn.addEventListener('click', () => {
      controls.reset();
      camera.position.set(80, 40, 80);
      controls.update();
    });

  </script>
</body>
</html>
