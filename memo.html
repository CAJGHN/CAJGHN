<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CAJGHN Memo</title>
<style>
  *{box-sizing:border-box;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;}
  body{margin:0;background:#fff;color:#111;display:flex;justify-content:center;padding:20px;}
  .wrap{width:100%;max-width:900px;display:grid;grid-template-columns:1fr 1fr;gap:20px;}
  header{grid-column:1/-1;text-align:center;margin-bottom:10px;}
  h1{margin:0;font-size:22px;font-weight:700;color:#000;}
  .card{border:1px solid #ddd;padding:20px;border-radius:10px;background:#fafafa;}
  label{font-size:14px;font-weight:600;margin-bottom:8px;display:block;color:#000;}
  input, textarea{width:100%;border:1px solid #ccc;border-radius:6px;padding:10px;font-size:14px;background:#fff;color:#000;}
  textarea{min-height:150px;resize:vertical;}
  button{padding:10px 14px;border:none;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600;}
  .btn-main{background:#000;color:#fff;}
  .btn-sub{background:#eee;color:#000;}
  .id-tag{display:inline-block;padding:6px 10px;border-radius:6px;background:#000;color:#fff;font-size:13px;margin-right:8px;}
  .hint{font-size:12px;color:#666;margin-bottom:10px;}
  .preview{white-space:pre-wrap;background:#fff;border:1px solid #ddd;border-radius:6px;padding:10px;min-height:120px;}
  .status{margin-top:10px;font-size:13px;color:#555;}
  @media(max-width:800px){.wrap{grid-template-columns:1fr;} }
</style>
</head>
<body>
<div class="wrap">
  <header><h1>CAJGHN Memo</h1></header>

  <section class="card">
    <label>새 메모 작성하기</label>
    <input id="newIdInput" type="text" placeholder="메모 번호를 입력하세요" />
    <div style="display:flex;gap:10px;margin:12px 0;">
      <button id="startNewBtn" class="btn-main">새 메모 시작</button>
      <button id="checkExistBtn" class="btn-sub">번호 검사</button>
    </div>

    <div id="creatorArea" style="display:none;">
      <span class="id-tag" id="creatorId"></span>
      <div class="hint">한 번 저장된 메모는 수정할 수 없습니다.</div>
      <textarea id="newContent" placeholder="메모 내용을 입력하세요"></textarea>
      <div style="display:flex;gap:10px;margin-top:10px;">
        <button id="saveBtn" class="btn-main">저장</button>
        <button id="cancelCreate" class="btn-sub">취소</button>
      </div>
      <div class="status" id="createStatus"></div>
    </div>
    <div class="status" id="newStatus"></div>
  </section>

  <section class="card">
    <label>작성한 메모 보기</label>
    <input id="viewIdInput" type="text" placeholder="메모 번호를 입력하세요" />
    <div style="display:flex;gap:10px;margin:12px 0;">
      <button id="viewBtn" class="btn-main">불러오기</button>
      <button id="reloadBtn" class="btn-sub">새로고침</button>
    </div>
    <div class="preview" id="viewPreview">메모가 여기에 표시됩니다.</div>
    <div class="status" id="viewStatus"></div>
  </section>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
import { getDatabase, ref, get, runTransaction } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyBOrSIFj3l2j6B4qvV5LRJMiOwTnvc8WAY",
  authDomain: "momo-f8e19.firebaseapp.com",
  projectId: "momo-f8e19",
  storageBucket: "momo-f8e19.firebasestorage.app",
  messagingSenderId: "906532822888",
  appId: "1:906532822888:web:85f77f33c3e10fe54e80dd"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const newIdInput = document.getElementById('newIdInput');
const startNewBtn = document.getElementById('startNewBtn');
const checkExistBtn = document.getElementById('checkExistBtn');
const creatorArea = document.getElementById('creatorArea');
const creatorId = document.getElementById('creatorId');
const newContent = document.getElementById('newContent');
const saveBtn = document.getElementById('saveBtn');
const cancelCreate = document.getElementById('cancelCreate');
const createStatus = document.getElementById('createStatus');
const newStatus = document.getElementById('newStatus');

const viewIdInput = document.getElementById('viewIdInput');
const viewBtn = document.getElementById('viewBtn');
const reloadBtn = document.getElementById('reloadBtn');
const viewPreview = document.getElementById('viewPreview');
const viewStatus = document.getElementById('viewStatus');

function normalizeId(id){ return String(id||'').trim(); }

async function existsMemo(id){
  id = normalizeId(id);
  if(!id) return false;
  const r = ref(db, 'memos/' + encodeURIComponent(id));
  const snap = await get(r);
  return snap.exists();
}

startNewBtn.addEventListener('click', async ()=>{
  createStatus.textContent = '';
  newStatus.textContent = '';
  const id = normalizeId(newIdInput.value);
  if(!id){ newStatus.textContent = '메모 번호를 입력하세요.'; return; }
  newStatus.textContent = '확인 중...';
  try{
    const r = ref(db, 'memos/' + encodeURIComponent(id));
    const snap = await get(r);
    if(snap.exists()){
      newStatus.textContent = '이미 있는 번호입니다.';
      return;
    }
    creatorId.textContent = id;
    newContent.value = '';
    creatorArea.style.display = 'block';
    newStatus.textContent = '';
  }catch(e){
    newStatus.textContent = '오류 발생.';
  }
});

checkExistBtn.addEventListener('click', async ()=>{
  const id = normalizeId(newIdInput.value);
  if(!id){ newStatus.textContent = '번호를 입력하세요.'; return; }
  newStatus.textContent = '확인 중...';
  try{
    const yes = await existsMemo(id);
    newStatus.textContent = yes ? '이미 있는 번호입니다.' : '사용 가능한 번호입니다.';
  }catch(e){
    newStatus.textContent = '오류 발생.';
  }
});

cancelCreate.addEventListener('click', ()=>{
  creatorArea.style.display = 'none';
  createStatus.textContent = '';
});

saveBtn.addEventListener('click', async ()=>{
  createStatus.textContent = '';
  const id = normalizeId(newIdInput.value);
  const content = newContent.value;
  if(!id){ createStatus.textContent = '번호가 없습니다.'; return; }
  if(!content.trim()){ createStatus.textContent = '내용을 입력하세요.'; return; }
  saveBtn.disabled = true;
  createStatus.textContent = '저장 중...';
  try{
    const r = ref(db, 'memos/' + encodeURIComponent(id));
    const result = await runTransaction(r, curr=>{
      if(curr === null){
        return { content: content, createdAt: Date.now() };
      } else {
        return;
      }
    });
    if(result.committed){
      createStatus.textContent = '저장되었습니다.';
      creatorArea.style.display = 'none';
    } else {
      createStatus.textContent = '이미 있는 번호입니다.';
    }
  }catch(e){
    createStatus.textContent = '저장 실패.';
  } finally {
    saveBtn.disabled = false;
  }
});

viewBtn.addEventListener('click', async ()=>{
  viewPreview.textContent = '불러오는 중...';
  viewStatus.textContent = '';
  const id = normalizeId(viewIdInput.value);
  if(!id){ viewStatus.textContent = '번호를 입력하세요.'; viewPreview.textContent = ''; return; }
  try{
    const r = ref(db, 'memos/' + encodeURIComponent(id));
    const snap = await get(r);
    if(!snap.exists()){
      viewPreview.textContent = '해당 메모가 없습니다.';
      viewStatus.textContent = '';
    } else {
      const d = snap.val();
      viewPreview.textContent = d.content;
      viewStatus.textContent = '저장일: ' + new Date(d.createdAt).toLocaleString();
    }
  }catch(e){
    viewPreview.textContent = '오류 발생.';
  }
});

reloadBtn.addEventListener('click', ()=>{
  const id = normalizeId(viewIdInput.value);
  if(id) viewBtn.click();
});
</script>
</body>
</html>

