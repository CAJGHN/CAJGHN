<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>CAJGHN Lounge</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
html, body { height:100%; margin:0; padding:0; background:#1e1e2f; color:#f5f5f5; font-family:sans-serif; }
body { display:flex; flex-direction:column; }
#nickname-overlay { position:fixed; inset:0; background:rgba(30,30,47,0.95); display:flex; justify-content:center; align-items:center; z-index:50; }
#nickname-form { display:flex; flex-direction:column; gap:12px; background:#2a2a3d; padding:24px; border-radius:16px; text-align:center; width:90%; max-width:320px; }
#nickname-form input { padding:10px; border-radius:8px; border:none; outline:none; background:#1e1e2f; color:#f5f5f5; width:100%; }
#nickname-form button { padding:10px 18px; border:none; border-radius:8px; background:#3b82f6; color:#fff; cursor:pointer; font-weight:bold; transition:all 0.2s; }
#nickname-form button:hover { background:#2563eb; }
#header { text-align:center; font-size:0.9rem; color:#f5f5f5; padding:8px 0; flex-shrink:0; }
#chat-section { display:flex; flex-direction:column; height:100vh; width:100%; max-width:1200px; margin:0 auto; }
#chat-container { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; word-wrap:break-word; }
.message { display:flex; flex-direction:column; max-width:80%; padding:10px 14px; border-radius:14px; word-break:break-word; white-space:pre-wrap; transition: transform 0.2s; cursor:default; }
.message.left { align-self:flex-start; background:#2a2a3d; color:#f5f5f5; }
.message.right { align-self:flex-end; background:#3b82f6; color:#fff; }
.meta { font-size:0.75rem; margin-top:6px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:4px; }
.message.right .meta span { color:#fff; }
.message.left .meta span { color:#f5f5f5; }
#input-container { display:flex; padding:12px; background:#2a2a3d; flex-shrink:0; position:sticky; bottom:0; z-index:10; align-items:center; }
#message-input { flex:1; padding:10px; border-radius:8px; border:none; outline:none; margin-right:10px; background:#1e1e2f; color:#f5f5f5; resize:none; }
#url-input { flex:1; padding:10px; border-radius:8px; border:none; outline:none; margin-right:10px; background:#1e1e2f; color:#f5f5f5; }
#send-btn { padding:10px 18px; background:#3b82f6; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:all 0.2s; }
#send-btn:hover { background:#2563eb; }
.message img { max-width:200px; border-radius:12px; cursor:pointer; transition: transform 0.2s; }
.message img:hover { transform: scale(1.05); }
#img-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:100; }
#img-modal img { max-width:90%; max-height:90%; border-radius:16px; }
.message a { color:#93c5fd; text-decoration:underline; }
.message a:hover { color:#60a5fa; }
.message.left a { color:#93c5fd; }
.message.left a:hover { color:#60a5fa; }
@media (max-width:500px){ #message-input,#url-input{font-size:0.9rem;} #send-btn{font-size:0.9rem;padding:8px 14px;} .message img{max-width:150px;} }
</style>
</head>
<body class="flex flex-col h-screen">

<div id="nickname-overlay">
  <form id="nickname-form">
    <h2 class="text-xl font-bold">Enter your nickname</h2>
    <input type="text" id="nickname-input" placeholder="Nickname" required />
    <button type="submit">Enter Lounge</button>
  </form>
</div>

<div id="chat-section">
  <div id="header"></div>
  <div id="chat-container"></div>
  <div id="input-container">
    <input type="text" id="url-input" placeholder="Image URL (optional)">
    <textarea id="message-input" placeholder="Type a message" rows="1"></textarea>
    <button id="send-btn">Send</button>
  </div>
</div>

<div id="img-modal">
  <img src="" id="modal-img">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, serverTimestamp, onChildAdded } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxGlseUWqf4uevaxiu407dZsx_YU6MPuo",
  authDomain: "tktk-a9131.firebaseapp.com",
  projectId: "tktk-a9131",
  storageBucket: "tktk-a9131.appspot.com",
  messagingSenderId: "541341583059",
  appId: "1:541341583059:web:be1791d22c6d33fdaeb626",
  databaseURL: "https://tktk-a9131-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userName = localStorage.getItem("cajghn_nickname") || "";

const nicknameOverlay = document.getElementById("nickname-overlay");
const nicknameForm = document.getElementById("nickname-form");
const nicknameInput = document.getElementById("nickname-input");
const chatContainer = document.getElementById("chat-container");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const header = document.getElementById("header");
const urlInput = document.getElementById("url-input");
const imgModal = document.getElementById("img-modal");
const modalImg = document.getElementById("modal-img");

function updateHeaderTime(){
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2,'0');
  const seconds = now.getSeconds().toString().padStart(2,'0');
  const ampm = hours>=12?'PM':'AM';
  const hour12=(hours%12)||12;
  const dateStr=`${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
  header.textContent=`${ampm} ${hour12}:${minutes}:${seconds} ${dateStr}`;
}
setInterval(updateHeaderTime,1000);

function formatTime(timestamp){
  const date = new Date(timestamp);
  const hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2,'0');
  const seconds = date.getSeconds().toString().padStart(2,'0');
  const ampm = hours>=12?'PM':'AM';
  const hour12=(hours%12)||12;
  return `${ampm} ${hour12}:${minutes}:${seconds}`;
}

function linkify(text){ return text.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'); }

function addMessage(name,text,timestamp,isImage=false){
  const div=document.createElement("div");
  div.classList.add("message", name===userName?"right":"left");
  if(isImage){
    div.innerHTML=`<img src="${text}"><div class="meta"><span>${name}</span><span>${formatTime(timestamp)}</span><a href="${text}" download style="margin-left:8px;color:#60a5fa;">Download</a></div>`;
    div.querySelector("img").addEventListener("click",()=>{ modalImg.src=text; imgModal.style.display="flex"; });
  }else{
    div.innerHTML=`<div>${linkify(text)}</div><div class="meta"><span>${name}</span><span>${formatTime(timestamp)}</span></div>`;
  }
  chatContainer.appendChild(div);
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

function watchMessages(){
  const messagesRef=ref(db,"messages");
  onChildAdded(messagesRef,snapshot=>{
    const msg=snapshot.val();
    addMessage(msg.name,msg.text,msg.timestamp||Date.now(),msg.isImage);
  });
}

sendBtn.addEventListener("click",async()=>{
  const text=messageInput.value.trim();
  const url=urlInput.value.trim();
  if(text || url){
    await push(ref(db,"messages"),{
      name:userName,
      text: url||text,
      timestamp:serverTimestamp(),
      isImage:!!url
    });
  }
  messageInput.value="";
  urlInput.value="";
});

messageInput.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }
});

nicknameForm.addEventListener("submit",(e)=>{
  e.preventDefault();
  const nick=nicknameInput.value.trim();
  if(!nick) return;
  userName=nick;
  localStorage.setItem("cajghn_nickname",nick);
  nicknameOverlay.style.display="none";
  watchMessages();
});

if(userName){ nicknameOverlay.style.display="none"; watchMessages(); }
imgModal.addEventListener("click",()=>{ imgModal.style.display="none"; });
</script>
</body>
</html>
