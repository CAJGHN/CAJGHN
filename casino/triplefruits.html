<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TRIPLE FRUITS</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    :root {
        --bg: #0A0A14;
        --panel: rgba(255, 255, 255, 0.06);
        --text: #F5F7FA;
        --subtext: #A0AEC0;
        --accent: #FFD700;
        --transition: 0.3s ease-out;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        background: var(--bg);
        color: var(--text);
        overflow: hidden;
        line-height: 1.6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        overscroll-behavior: none;
        cursor: default;
    }

    .game-container {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 40px;
        width: 100%; max-width: 900px;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .game-header {
        margin-bottom: 30px;
        display: flex; justify-content: center; align-items: center;
        padding-bottom: 20px;
    }

    .game-title {
        font-size: 32px; font-weight: 900; color: var(--text);
        letter-spacing: 2px;
    }

    .slot-window {
        background: #000;
        border-radius: 10px;
        padding: 10px;
        display: flex; justify-content: space-between; gap: 10px;
        margin-bottom: 30px;
        position: relative;
    }

    .reel-col {
        flex: 1; height: 240px;
        background: #F0F2F5;
        border-radius: 5px; overflow: hidden; position: relative;
    }

    .reel-strip {
        width: 100%; position: absolute; top: 0; left: 0;
        will-change: transform; transform: translateZ(0); 
    }

    .symbol {
        height: 240px;
        display: flex; justify-content: center; align-items: center;
        font-size: 100px;
        line-height: 1;
        border: none; 
        background: #F0F2F5; box-sizing: border-box;
        color: #000; 
    }

    .sym-seven {
        color: var(--accent) !important; 
        font-weight: 900; 
    }

    .dashboard {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(0,0,0,0.3);
        padding: 20px 30px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-box { 
        display: flex;
        flex-direction: column;
        align-items: center;      
        justify-content: center; 
        min-width: 100px;
    }

    .stat-label { 
        font-size: 14px; 
        color: var(--subtext); 
        font-weight: 600; 
        letter-spacing: 1px; 
        margin-bottom: 4px;
        text-align: center;       
    }

    .stat-value { 
        font-size: 24px; 
        color: var(--text); 
        font-weight: 700; 
        font-variant-numeric: tabular-nums; 
    }
    
    .controls { display: flex; gap: 30px; align-items: center; }

    .bet-container { 
        display: flex; 
        flex-direction: column; 
        align-items: center;      
        justify-content: center; 
    }

    .bet-row {
        display: flex; align-items: center; gap: 15px;
        padding: 5px;
    }

    .bet-val {
        min-width: 60px; text-align: center;
        font-size: 24px; font-weight: 700; color: var(--text);
        font-variant-numeric: tabular-nums;
    }

    .btn-simple {
        background: transparent;
        border: none;
        color: var(--subtext);
        font-size: 32px;
        line-height: 1;
        cursor: pointer;
        font-weight: 700;
        padding: 0 5px;
        transition: color 0.2s;
        outline: none;
    }

    .btn-simple:hover:not(:disabled) { color: var(--accent); }
    .btn-simple:active:not(:disabled) { transform: scale(0.9); }
    .btn-simple:disabled { opacity: 1; cursor: default; }

    .btn-spin {
        display: block;
        padding: 12px 40px; 
        background: var(--accent);
        border: 1px solid var(--accent);
        color: #000;
        text-align: center;
        text-decoration: none;
        font-size: 15px; 
        font-weight: 700;
        text-transform: none; 
        border-radius: 6px;
        transition: var(--transition);
        cursor: pointer;
        box-shadow: none; 
        outline: none;
    }

    .btn-spin:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-2px);
        background: var(--accent);
        box-shadow: none;
    }

    .btn-spin:disabled {
        opacity: 1;
        cursor: not-allowed;
        transform: none;
    }

    @media (max-width: 700px) {
        .game-container { padding: 20px; }
        .game-header { margin-bottom: 20px; padding-bottom: 15px; }
        .game-title { font-size: 24px; }
        
        .slot-window { gap: 5px; padding: 5px; margin-bottom: 20px; }
        .reel-col { height: 140px; border-radius: 4px; }
        .symbol { height: 140px; font-size: 60px; }
        
        .dashboard { flex-direction: column; gap: 20px; padding: 20px 15px; }
        .stat-box { width: 100%; flex-direction: row; justify-content: space-between; padding: 0 10px; }
        .stat-label { margin-bottom: 0; text-align: left; }
        
        .controls { flex-direction: column; width: 100%; gap: 15px; }
        .bet-container { width: 100%; }
        .bet-row { width: 100%; justify-content: space-between; padding: 0 20px; background: rgba(255,255,255,0.03); border-radius: 8px; }
        
        .btn-spin { width: 100%; padding: 12px 0; font-size: 16px; }
    }

    @media (max-width: 380px) {
        .reel-col { height: 110px; }
        .symbol { height: 110px; font-size: 50px; }
    }
</style>
</head>
<body>

    <div class="game-container">
        
        <div class="game-header">
            <div class="game-title">TRIPLE FRUITS</div>
        </div>

        <div class="slot-window">
            <div class="reel-col">
                <div class="reel-strip" id="reel1"></div>
            </div>
            <div class="reel-col">
                <div class="reel-strip" id="reel2"></div>
            </div>
            <div class="reel-col">
                <div class="reel-strip" id="reel3"></div>
            </div>
        </div>

        <div class="dashboard">
            <div class="stat-box">
                <div class="stat-label">POINTS</div>
                <div class="stat-value" id="pointDisplay">0</div>
            </div>

            <div class="controls">
                <div class="bet-container">
                    <div class="stat-label">BET</div>
                    <div class="bet-row">
                        <button class="btn-simple" id="btnMinus" onclick="adjustBet(-100)">-</button>
                        <div class="bet-val" id="betDisplay">100</div>
                        <button class="btn-simple" id="btnPlus" onclick="adjustBet(100)">+</button>
                    </div>
                </div>
                <button class="btn-spin" id="spinBtn" onclick="spin()">SPIN</button>
            </div>
        </div>

    </div>

<script>
    const SUPABASE_URL = "https://nzdbalmwypdixduickzv.supabase.co"; 
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZGJhbG13eXBkaXhkdWlja3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNjc0MjgsImV4cCI6MjA4MDk0MzQyOH0.xskVDK0fIedVzC74bluatdhzXHY8ujKJVCQTiVcy824";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let points = 0;
    let bet = 100;
    let isSpinning = false;

    const symbolTypes = [
        { id: 'ðŸ’', val: 10 },
        { id: 'ðŸ‹', val: 20 },
        { id: 'ðŸ‡', val: 30 },
        { id: 'ðŸ‰', val: 40 },
        { id: '7', val: 77, customClass: 'sym-seven' }
    ];

    const elPoints = document.getElementById('pointDisplay');
    const elBet = document.getElementById('betDisplay');
    const elSpinBtn = document.getElementById('spinBtn');
    const elBtnMinus = document.getElementById('btnMinus');
    const elBtnPlus = document.getElementById('btnPlus');
    
    const reelHeight = 240; 
    const reels = [
        document.getElementById('reel1'),
        document.getElementById('reel2'),
        document.getElementById('reel3')
    ];

    async function initGame() {
        const { data: { session } } = await supabase.auth.getSession();
        
        if (!session) {
            alert("Login Required.");
            window.location.href = "https://cajghn.com/casino/";
            return;
        }

        currentUser = session.user;
        await fetchBalance();

        reels.forEach(r => initReel(r));
        updateUI();
    }

    async function fetchBalance() {
        const { data, error } = await supabase
            .from('users')
            .select('point')
            .eq('id', currentUser.id)
            .single();

        if (data) {
            points = data.point;
            updateUI();
        }
    }

    function initReel(element) {
        let html = '';
        for(let i=0; i<4; i++) {
            const sym = getRandomSymbol();
            html += createSymbolHTML(sym);
        }
        element.innerHTML = html;
        element.style.transform = `translateY(0px)`;
    }

    function getRandomSymbol() {
        return symbolTypes[Math.floor(Math.random() * symbolTypes.length)];
    }

    function createSymbolHTML(sym) {
        const extraClass = sym.customClass ? sym.customClass : '';
        return `<div class="symbol ${extraClass}" data-id="${sym.id}">${sym.id}</div>`;
    }

    function adjustBet(amount) {
        if(isSpinning) return;
        const newBet = bet + amount;
        if(newBet >= 100) {
            bet = newBet;
            updateUI();
        }
    }

    function updateUI() {
        elPoints.innerText = points.toLocaleString();
        elBet.innerText = bet;
    }

    async function spin() {
        if(isSpinning) return;

        await fetchBalance();

        if(points < bet) {
            alert("Insufficient Points!");
            return;
        }

        const newBalance = points - bet;
        const { error } = await supabase
            .from('users')
            .update({ point: newBalance })
            .eq('id', currentUser.id);

        if (error) {
            alert("Error updating balance.");
            return;
        }

        points = newBalance;
        isSpinning = true;
        elSpinBtn.disabled = true;
        elBtnMinus.disabled = true;
        elBtnPlus.disabled = true;
        updateUI();

        const results = [];
        const spinPromises = [];

        reels.forEach((reel, i) => {
            const targetSym = getRandomSymbol();
            results.push(targetSym);

            const extraSymbols = 12 + (i * 4); 
            let appendHtml = '';
            
            for(let k=0; k<extraSymbols; k++) {
                appendHtml += createSymbolHTML(getRandomSymbol());
            }
            appendHtml += createSymbolHTML(targetSym);
            
            reel.insertAdjacentHTML('beforeend', appendHtml);

            const totalSymbols = reel.children.length;
            const targetIndex = totalSymbols - 1;
            const duration = 2 + (i * 0.5);

            const p = new Promise((resolve) => {
                reel.style.transition = `transform ${duration}s cubic-bezier(0.15, 0.9, 0.35, 1)`;
                
                const actualHeight = reel.firstElementChild.offsetHeight;
                reel.style.transform = `translateY(-${targetIndex * actualHeight}px)`;

                setTimeout(() => {
                    resolve();
                }, duration * 1000);
            });
            spinPromises.push(p);
        });

        Promise.all(spinPromises).then(() => {
            setTimeout(() => {
                checkWin(results);
                cleanupReels(results); 
            }, 500); 
        });
    }

    function cleanupReels(finalSymbols) {
        reels.forEach((reel, i) => {
            const targetSym = finalSymbols[i];
            reel.style.transition = 'none';
            
            let newHtml = createSymbolHTML(targetSym); 
            for(let k=0; k<3; k++) newHtml += createSymbolHTML(getRandomSymbol());
            
            reel.innerHTML = newHtml;
            reel.style.transform = `translateY(0px)`;
        });
    }

    async function checkWin(results) {
        const s1 = results[0];
        const s2 = results[1];
        const s3 = results[2];

        if(s1.id === s2.id && s2.id === s3.id) {
            let winAmount = bet * s1.val;
            
            const newBalance = points + winAmount;
            const { error } = await supabase
                .from('users')
                .update({ point: newBalance })
                .eq('id', currentUser.id);
            
            if (!error) {
                points = newBalance;
            }
        } 
        
        isSpinning = false;
        elSpinBtn.disabled = false;
        elBtnMinus.disabled = false;
        elBtnPlus.disabled = false;
        updateUI();
    }

    window.addEventListener('resize', () => {
        if(!isSpinning) {
            reels.forEach(reel => reel.style.transform = `translateY(0px)`);
        }
    });

    initGame();
</script>

</body>
</html>
