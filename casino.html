<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAJGHN Casino</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0; padding: 0; 
            text-align: center; 
            background-color: white; color: black;
        }
        .header {
            border-bottom: 2px solid black; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center; 
            font-weight: bold; font-size: 14px;
        }
        .brand-name { font-size: 18px; font-weight: 900; }
        .refresh-btn { cursor: pointer; margin-left: 5px; font-size: 16px; user-select: none; }
        .game-area { margin-top: 30px; display: flex; flex-direction: column; align-items: center; }
        canvas { 
            border: 2px solid black; 
            margin: 20px 0; 
            background: #ffffff;
        }
        .controls { margin-bottom: 30px; }
        input { 
            padding: 10px; border: 1px solid black; text-align: right; 
            width: 200px; font-size: 16px; outline: none;
            font-family: inherit;
        }
        .btn {
            background: white; border: 1px solid black; padding: 10px 25px; 
            cursor: pointer; font-size: 15px; font-weight: bold; 
            transition: 0.1s; margin: 5px;
            font-family: inherit;
        }
        .btn:hover:not(:disabled) { background: black; color: white; }
        .btn:active:not(:disabled) { transform: translateY(2px); }
        .btn:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; }
        .check-btn { width: 60px; padding: 10px 5px; font-size: 13px; }
        .modal-overlay {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            border: 2px solid black; padding: 40px 30px; width: 320px; 
            text-align: center; background: white; 
        }
        .modal-title { font-size: 24px; font-weight: 900; margin-bottom: 20px; margin-top: 0; }
        .modal-box input { width: 100%; margin: 8px 0; box-sizing: border-box; text-align: left; }
        .input-group { display: flex; gap: 5px; width: 100%; }
        #result-msg { font-size: 18px; font-weight: bold; height: 30px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="start-modal" class="modal-overlay">
        <div class="modal-box">
            <h1 class="modal-title">CAJGHN Casino</h1>
            <p style="margin-bottom: 30px;">당신의 운을 시험하세요.</p>
            <button class="btn" style="width:100%" onclick="openModal('login-modal')">로그인</button>
            <button class="btn" style="width:100%" onclick="openModal('join-modal')">회원가입</button>
        </div>
    </div>

    <div id="login-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h2 class="modal-title">LOGIN</h2>
            <input type="text" id="login-id" placeholder="아이디">
            <input type="password" id="login-pw" placeholder="비밀번호">
            <br><br>
            <button class="btn" style="width:100%" onclick="processLogin()">입장하기</button>
            <button class="btn" style="width:100%; border:none; text-decoration: underline;" onclick="showStart()">뒤로가기</button>
        </div>
    </div>

    <div id="join-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <h2 class="modal-title">JOIN</h2>
            <div class="input-group">
                <input type="text" id="join-id" placeholder="아이디 (영어)">
                <button class="btn check-btn" onclick="checkDuplicate('id')">확인</button>
            </div>
            <input type="password" id="join-pw" placeholder="비밀번호 (6자 이상)">
            <input type="password" id="join-pw-confirm" placeholder="비밀번호 확인">
            <div class="input-group">
                <input type="text" id="join-name" placeholder="닉네임">
                <button class="btn check-btn" onclick="checkDuplicate('name')">확인</button>
            </div>
            <br><br>
            <button class="btn" style="width:100%" onclick="processJoin()">가입완료</button>
            <button class="btn" style="width:100%; border:none; text-decoration: underline;" onclick="showStart()">취소</button>
        </div>
    </div>

    <div id="main-screen" style="display:none;">
        <div class="header">
            <span class="brand-name">CAJGHN Casino</span>
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #666;">PLAYER: <span id="user-name" style="color:black; font-weight:bold;">-</span></div>
                <div>
                    POINT: <span id="user-point" style="font-size: 16px;">0</span>
                    <span class="refresh-btn" onclick="fetchUserPoint()" title="잔액 새로고침">↻</span>
                </div>
            </div>
        </div>

        <div class="game-area">
            <h3 style="margin:0;">LADDER GAME (x2)</h3>
            <div id="result-msg">배팅하고 출발을 선택하세요</div>
            
            <canvas id="ladderCanvas" width="320" height="420"></canvas>
            
            <div class="controls">
                <input type="number" id="bet-amount" placeholder="배팅금 입력" min="100">
                <br><br>
                <button class="btn" id="btn-left" onclick="startGame(1)">왼쪽 (L)</button>
                <button class="btn" id="btn-right" onclick="startGame(2)">오른쪽 (R)</button>
            </div>
            
            <button class="btn" style="border:none; text-decoration:underline; font-size:12px; color:#666;" onclick="logout()">로그아웃</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://nzdbalmwypdixduickzv.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56ZGJhbG13eXBkaXhkdWlja3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNjc0MjgsImV4cCI6MjA4MDk0MzQyOH0.xskVDK0fIedVzC74bluatdhzXHY8ujKJVCQTiVcy824";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const FAKE_DOMAIN = "@game.com";
        
        let currentUser = null;
        let currentPoint = 0;
        let isPlaying = false; 
        let idChecked = false;
        let nameChecked = false;

        const canvas = document.getElementById('ladderCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;
        const LINE_X = [W * 0.3, W * 0.7]; 

        function showStart() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
            document.getElementById('start-modal').style.display = 'flex';
        }
        function openModal(id) {
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
            document.querySelectorAll('input').forEach(input => input.value = '');
        }

        async function checkDuplicate(type) {
            const inputId = type === 'id' ? 'join-id' : 'join-name';
            const value = document.getElementById(inputId).value.trim();
            if (!value) return alert("입력하세요.");

            const col = type === 'id' ? 'real_id' : 'name';
            const { data } = await supabase.from('users').select('*').eq(col, value);

            if (data && data.length > 0) {
                alert("이미 있습니다.");
                if(type === 'id') idChecked = false; else nameChecked = false;
            } else {
                alert("사용 가능합니다.");
                if(type === 'id') idChecked = true; else nameChecked = true;
            }
        }

        async function processJoin() {
            const id = document.getElementById('join-id').value.trim();
            const pw = document.getElementById('join-pw').value.trim();
            const pw2 = document.getElementById('join-pw-confirm').value.trim();
            const name = document.getElementById('join-name').value.trim();

            if (!id || !name) return alert("빈칸을 채워주세요.");
            if (pw !== pw2) return alert("비번 불일치");
            if (!idChecked || !nameChecked) return alert("중복 확인 필요");
            if (pw.length < 6) return alert("비번 6자 이상");

            const { data, error } = await supabase.auth.signUp({
                email: id + FAKE_DOMAIN,
                password: pw
            });
            
            if (error) return alert("가입 실패: " + error.message);

            const { error: dbError } = await supabase.from('users').insert({
                id: data.user.id,
                real_id: id,
                name: name,
                point: 0
            });

            if (dbError) alert("DB 에러: " + dbError.message);
            else {
                alert("가입 완료. 로그인 해주세요.");
                openModal('login-modal');
            }
        }

        async function processLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: id + FAKE_DOMAIN,
                password: pw
            });

            if (error) return alert("로그인 실패");

            currentUser = data.user;
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
            document.getElementById('main-screen').style.display = 'block';
            
            fetchUserPoint();
            drawBasicLadder(); 
        }

        async function fetchUserPoint() {
            if (!currentUser) return;
            const { data } = await supabase.from('users').select('*').eq('id', currentUser.id).single();
            if (data) {
                currentPoint = data.point;
                document.getElementById('user-name').innerText = data.name;
                document.getElementById('user-point').innerText = currentPoint.toLocaleString();
            }
        }

        function drawBasicLadder() {
            ctx.clearRect(0, 0, W, H);
            
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#333";
            ctx.fillStyle = "#333";
            ctx.font = "bold 24px system-ui"; 

            ctx.beginPath();
            ctx.moveTo(LINE_X[0], 50); ctx.lineTo(LINE_X[0], H - 50);
            ctx.moveTo(LINE_X[1], 50); ctx.lineTo(LINE_X[1], H - 50);
            ctx.stroke();

            ctx.fillText("L", LINE_X[0]-8, 35);
            ctx.fillText("R", LINE_X[1]-8, 35);
            
            ctx.font = "bold 20px system-ui";
            ctx.fillText("WIN", LINE_X[0]-20, H - 20);
            ctx.fillText("LOSE", LINE_X[1]-25, H - 20);
        }

        async function startGame(startPos) {
            if (isPlaying) return;
            const betInput = document.getElementById('bet-amount');
            let bet = parseInt(betInput.value);

            if (isNaN(bet) || bet <= 0) return alert("배팅금을 입력하세요.");
            if (bet > currentPoint) return alert("포인트가 부족합니다.");

            isPlaying = true;
            document.getElementById('result-msg').innerText = "진행 중...";
            toggleButtons(false);

            const newPoint = currentPoint - bet;
            const { error } = await supabase.from('users').update({ point: newPoint }).eq('id', currentUser.id);
            if (error) { alert("통신 오류"); isPlaying = false; toggleButtons(true); return; }
            currentPoint = newPoint;
            document.getElementById('user-point').innerText = currentPoint.toLocaleString();

            const bridges = [];
            const minGap = 40; 
            const maxBridges = Math.floor(Math.random() * 4) + 4; 
            let attempts = 0;

            while (bridges.length < maxBridges && attempts < 100) {
                const y = 70 + Math.random() * (H - 140);
                let tooClose = false;
                for (let b of bridges) {
                    if (Math.abs(b - y) < minGap) {
                        tooClose = true;
                        break;
                    }
                }
                if (!tooClose) bridges.push(y);
                attempts++;
            }
            bridges.sort((a, b) => a - b); 

            animateLadder(startPos - 1, bridges, bet);
        }

        function animateLadder(startIndex, bridges, bet) {
            let xIdx = startIndex; 
            let currentY = 50;
            let bridgeIdx = 0;
            
            const loop = setInterval(async () => {
                drawBasicLadder(); 
                
                ctx.beginPath();
                ctx.strokeStyle = "#333";
                for(let b of bridges) { 
                    ctx.moveTo(LINE_X[0], b); 
                    ctx.lineTo(LINE_X[1], b); 
                }
                ctx.stroke();

                const px = LINE_X[xIdx];
                ctx.beginPath();
                ctx.arc(px, currentY, 8, 0, Math.PI * 2); 
                ctx.fillStyle = "red";
                ctx.fill();

                if (currentY < H - 50) {
                    if (bridgeIdx < bridges.length && Math.abs(currentY - bridges[bridgeIdx]) < 3) {
                        xIdx = xIdx === 0 ? 1 : 0; 
                        bridgeIdx++;
                        currentY += 10; 
                    } else {
                        currentY += 2;
                    }
                } else {
                    clearInterval(loop);
                    
                    if (xIdx === 0) { 
                        const winAmount = bet * 2;
                        document.getElementById('result-msg').innerText = `축하합니다! +${winAmount}P`;
                        document.getElementById('result-msg').style.color = "blue"; 
                        const finalPoint = currentPoint + winAmount;
                        await supabase.from('users').update({ point: finalPoint }).eq('id', currentUser.id);
                        fetchUserPoint();
                    } else { 
                        document.getElementById('result-msg').innerText = `꽝...`;
                        document.getElementById('result-msg').style.color = "red"; 
                    }
                    isPlaying = false;
                    toggleButtons(true);
                }
            }, 10);
        }

        function toggleButtons(enable) {
            document.getElementById('btn-left').disabled = !enable;
            document.getElementById('btn-right').disabled = !enable;
        }

        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }
    </script>
</body>
</html>